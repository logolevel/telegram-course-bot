<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 2em; background-color: #f4f6f9; color: #333; }
        .container { max-width: 900px; margin: auto; background-color: #fff; padding: 2em; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #1a1a1a; }
        
        nav { text-align: center; margin-bottom: 2em; }
        nav a { margin: 0 15px; text-decoration: none; color: #007bff; font-weight: bold; font-size: 18px; padding-bottom: 2px; border-bottom: 2px solid transparent; }
        nav a:hover { text-decoration: none; border-bottom-color: #007bff; }
        nav a.active {
            color: #333;
            border-bottom-color: #333;
            pointer-events: none;
            cursor: default;
        }

        .filter-form { text-align: center; margin-top: 2em; margin-bottom: 2em; background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .filter-form input, .filter-form button { padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin: 0 5px; }
        .filter-form button { background-color: #007bff; color: white; cursor: pointer; border-color: #007bff; }
        .filter-form a { color: #6c757d; text-decoration: none; line-height: 40px; margin-left: 10px; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –±–æ—Ç—É</h1>

        <nav>
            <a href="/stats" class="<%= page === 'stats' ? 'active' : '' %>">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
            <a href="/users" class="<%= page === 'users' ? 'active' : '' %>">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
        </nav>
        
        <h2>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–∞–∑–µ: <b><%= totalUsers %></b></h2>

        <div class="filter-form">
            <form action="/stats" method="get">
                <label for="month">–ú–µ—Å—è—Ü:</label>
                <input type="number" id="month" name="month" min="1" max="12" placeholder="MM">
                <label for="year">–ì–æ–¥:</label>
                <input type="number" id="year" name="year" min="2024" placeholder="YYYY" value="2025">
                <button type="submit">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
                <a href="/stats">–°–±—Ä–æ—Å–∏—Ç—å</a>
            </form>
        </div>

        <h2>–í–æ—Ä–æ–Ω–∫–∞ (<%= currentFilter %>)</h2>
        <canvas id="funnelChart"></canvas>
    </div>

    <script>
        const ctx = document.getElementById('funnelChart').getContext('2d');
        const stageData = <%- JSON.stringify(stageStats) %>;
        
        const getLabel = (serverStageName) => {
            const map = {
                'Entered Bot (Total)': '–ó–∞—à–ª–∏ –≤ –±–æ—Ç (–í—Å–µ–≥–æ)',
                'Started Practice (New)': '–ù–∞—á–∞–ª–∏ –ø—Ä–∞–∫—Ç–∏–∫—É (–ù–æ–≤–∞—è)',
                'Watched Video': '–í–∫–ª—é—á–∏–ª–∏ –≤–∏–¥–µ–æ',
                'Finished Practice': '–ó–∞–≤–µ—Ä—à–∏–ª–∏ –ø—Ä–∞–∫—Ç–∏–∫—É',
                'Uploaded Photo': '–ó–∞–≥—Ä—É–∑–∏–ª–∏ —Ñ–æ—Ç–æ',
                'Old Flow Start': '–°—Ç–∞—Ä–∞—è –≤–æ—Ä–æ–Ω–∫–∞ (Start)'
            };
            return map[serverStageName] || serverStageName;
        };

        const labels = stageData.map(item => getLabel(item.stage));
        const dataValues = stageData.map(item => item.count);

        new Chart(ctx, {
            type: 'bar', 
            data: {
                labels: labels,
                datasets: [{
                    label: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
                    data: dataValues,
                    backgroundColor: [
                        'rgba(108, 117, 125, 0.5)', 
                        'rgba(40, 167, 69, 0.6)',   
                        'rgba(23, 162, 184, 0.6)',  
                        'rgba(255, 193, 7, 0.6)',   
                        'rgba(255, 99, 132, 0.6)',  
                        'rgba(200, 200, 200, 0.3)'  
                    ],
                    borderColor: [
                        'rgba(108, 117, 125, 1)',
                        'rgba(40, 167, 69, 1)',
                        'rgba(23, 162, 184, 1)',
                        'rgba(255, 193, 7, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(200, 200, 200, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    </script>
</body>
</html>